div(data-controller="message-form" data-message-form-unit-id-value="#{@unit.id}")
  .md:border.md:rounded-xl.md:p-12.mt-6.md:drop-shadow-lg.bg-white.dark:bg-stone-800.dark:border-stone-700
    .hiddenz
      = file_field_tag :attachments,
                       multiple: true,
                       data: { message_form_target: "fileInput", action: "message-form#addAttachments" }

    = form_with model: @message,
                url: @message.new_record? ? unit_messages_path(@unit) : unit_message_path(@unit, @message),
                method: @message.new_record? ? "post" : "patch",
                data: { turbo_action: "advance", "message-form-unit-id-value" => @unit.id } do |f|   

      section.flex.flex-col.divide-y.dark:divide-stone-600.text-sm.md:text-base
        // FROM
        div#sender_wrapper.flex.flex-row.gap-6.py-4.items-center
          = f.label :sender, t("messages.form.labels.from")
          = f.label :sender_address, @unit.from_address, class: "ellipsis truncate"

        // TO
        div#recipient_wrapper.py-2(data-controller="dropdown" data-action="keydown->dropdown#handleKeydown")
          .flex.flex-row.gap-4.justify-between.items-start
            = f.label :groups, "To", class: "inline-block py-2"

            .auto-complete-field.w-full.flex.gap-1.flex-wrap(data-controller="selectable-list" data-message-form-target="recipientList")

              // RECIPIENTS GO HERE
              / .recipient.inline-block.rounded.p-2.bg-lime-100.font-semibold.whitespace-nowrap = "Frank Poncharello"
              / .recipient.inline-block.rounded.p-2.bg-lime-100.font-semibold.whitespace-nowrap = "Jon Baker"
              / .recipient.inline-block.rounded.p-2.bg-lime-100.font-semibold.whitespace-nowrap = "Joe Getraer"
              / .recipient.inline-block.rounded.p-2.bg-lime-100.font-semibold.whitespace-nowrap = "Gene Fritz"
              / .recipient.inline-block.rounded.p-2.bg-lime-100.font-semibold.whitespace-nowrap = "Arthur Grossman"
              / .recipient.inline-block.rounded.p-2.bg-lime-100.font-semibold.whitespace-nowrap = "Harlan Arliss"
              / .recipient.inline-block.rounded.p-2.bg-lime-100.font-semibold.whitespace-nowrap = "Barry Baricza"

              #recipient_search_query.relative.w-full.flex.grow.shrink.basis-0
                = text_field :recipient_search, "", autofocus: true,
                            class: "ml-1 px-0 bg-transparent border-0 focus:ring-0 w-full grow text-sm md:text-base",
                            data: { action: "input->message-form#searchRecipients keydown->message-form#handleKeydown",
                                    message_form_target: "queryInput", selectable_list_target: "queryInput" }

                ul#search_results.absolute.top-full.bg-lime-600.text-white.max-h-96.overflow-y-scroll.rounded-b.z-50(data-message-form-target="searchResults" \
                  data-selectable-list-commit-url-value="#{unit_messages_path(@unit)}")

            .right
              = link_to "#",
                        class: "block w-full py-3 flex flex-row justify-between items-center ml-auto",
                        data: { dropdown_target: "toggle", action: "dropdown#toggle" } do
                i.fa-solid.fa-chevron-down.text-stone-500

        // SUBJECT
        div#subject_wrapper.flex.flex-row.gap-6.py-4.items-center
          = f.label :subject, t("messages.form.labels.subject")

          = f.text_field :title,
                          autofocus: true,
                          autocomplete: "off",
                          class: "p-0 w-full border-0 bg-transparent placeholder-stone-400 dark:placeholder-stone-500 disabled:text-stone-300 " \
                                 "disabled:placeholder-stone-200 ring-0 focus:ring-0 text-sm md:text-base",
                          placeholder: t("messages.form.placeholders.subject"),
                          data: { message_form_target: "subjectTextBox", action: "message-form#validate" }

        // ATTACHMENTS
        div#attachments_section.flex.flex-row.gap-6.py-4.items-center(data-message-form-target="attachmentWrapper" class="#{ 'hidden' unless @message.attachments.any? }")
          = label nil, :attachments, t("messages.form.labels.attachments")
          .flex.flex-row.flex-wrap.gap-1.(data-message-form-target="attachmentList")
            - @message.attachments.each do |attachment|
              div.pl-2.py-0.rounded.bg-stone-200.dark:bg-stone-700.inline-block.flex.flex-row.items-center.gap-1
                .inline-block.text-ellipsis.whitespace-nowrap.overflow-hidden(style="max-width: 12rem;")
                  = attachment.filename
                = link_to raw("&times;"),
                            unit_message_attachment_path(message.unit, message, attachment),
                            class: "inline-block py-1 px-3 ml-1 hover:text-red-500",
                            data: { turbo_method: "delete", turbo_stream: true }

        // BODY
        div#body_wrapper.py-2
          = f.rich_text_area :body,
                            class: "p-0 focus:outline-none border-0 overflow-auto border border-stone-400 dark:border-stone-500 placeholder-stone-400 dark:placeholder-stone-500",
                            placeholder: "Type your message...",
                            data: { message_form_target: "bodyTextArea", action: "trix-change->message-form#validate" }

        // FOOTER
        footer.border-t.pt-4.dark:border-stone-500
          - unless MessagePolicy.new(@current_member, @message).create?
            p.text-sm.font-bold
              i.fa-solid.fa-circle-info.mr-1
              | Your message will be sent to unit leadership for approval before being sent.

          .flex.flex-col.md:flex-row.bottom-0.sticky.gap-2.md:gap-10

            - submit_caption = MessagePolicy.new(@current_member, @message).create? ? "Send Now" : "Submit for Approval"

            // LEFT SIDE
            div.flex.flex-row

              // SEND NOW BUTTON

              = f.button submit_caption,
                        type: "submit",
                        name: "commit",
                        disabled: true,
                        value: t("messages.captions.send_message"),
                        class: "w-full md:w-fit block px-4 py-2 font-bold text-white bg-lime-600 hover:bg-lime-700 disabled:bg-lime-200 dark:disabled:bg-lime-900 dark:disabled:text-lime-700 rounded disabled:cursor-not-allowed",
                        id: "send_message_button",
                        data: { message_form_target: "sendMessageButton" }
            
            // RIGHT SIDE
            div.flex.flex-row
              // send later
              .relative.dropdown(data-controller="dropdown")
                // send later dropdown ("dropup")
                .dropdown-menu.absolute.p-3.bg-white.dark:bg-black.border.border-stone-300.dark:border-stone-600.rounded.drop-shadow-lg.flex.flex-col.gap-2.min-w-96.bottom-full.-translate-x-1/2.left-1/2.mb-2(data-dropdown-target="dropdown")
                  = link_to "#",
                            class: "absolute right-0 top-0 text-xl px-3 py-2 cursor-pointer",
                            data: { action: "message-form#toggleSendLater" } do
                    i.fa-solid.fa-times
                  = f.label :send_at, "Send later", class: "block font-bold"
                  = f.date_field :send_at, class: "w-full rounded border-stone-300"
                  = f.button t("messages.captions.schedule_and_save"),
                            type: "submit",
                            title: "Schedule and save",
                            name: "commit",
                            value: t("messages.captions.schedule_and_save"),
                            class: "block mt-2 px-3 py-2 bg-lime-600 text-white hover:bg-lime-700 dark:hover:text-stone-300 cursor-pointer whitespace-nowrap rounded font-bold"

                = f.button t("messages.captions.send_later"),
                          type: "submit",
                          title: "Send later",
                          disabled: true,
                          value: t("messages.captions.send_preview"),
                          name: "commit",
                          id: "send_later_button",
                          class: "text-xl px-3 py-2 text-lime-600 hover:text-lime-700 dark:hover:text-stone-300 disabled:text-lime-200 dark:disabled:hover:text-lime-900 cursor-pointer dark:disabled:text-lime-900 disabled:cursor-not-allowed",
                          data: { message_form_target: "sendLaterButton", action: "dropdown#toggle" } do
                    i.fa-solid.fa-calendar-days

              // send preview
              = f.button t("messages.captions.send_preview"),
                        type: "submit",
                        title: "Send a preview to yourself",
                        disabled: true,
                        value: t("messages.captions.send_preview"),
                        name: "commit",
                        id: "send_preview_button",
                        class: "text-xl w-full md:w-fit px-3 py-2 text-lime-600 hover:text-lime-700 dark:hover:text-stone-300 disabled:text-lime-200 cursor-pointer dark:disabled:text-lime-900 dark:disabled:hover:text-lime-900 disabled:cursor-not-allowed",
                        data: { message_form_target: "sendPreviewButton" } do
                  i.fa-solid.fa-glasses-round

              // save draft
              = f.button t("messages.captions.save_draft"),
                        type: "submit",
                        class: "text-xl py-2 px-3 rounded uppercase text-lime-600 hover:text-lime-700 dark:hover:text-stone-300 cursor-pointer",
                        value: t("messages.captions.save_draft"),
                        name: "commit",
                        title: "Save as a draft" do
                  i.fa-solid.fa-floppy-disk

              // attach files
              = f.button "Attach",
                        type: "button",
                        title: "Attach files",
                        value: "attach",
                        name: "attach",
                        class: "text-xl w-full md:w-fit px-3 py-2 text-lime-600 hover:text-lime-700 dark:hover:text-stone-300 cursor-pointer",
                        data: { action: "message-form#uploadFiles" } do
                  i.fa-solid.fa-paperclip

              // toggle formatting
              = link_to "#",
                        class: "text-xl w-full md:w-fit px-3 py-2 text-lime-600 hover:text-lime-700 dark:hover:text-stone-300 cursor-pointer",
                        data: { action: "message-form#toggleFormattingToolbar" } do

                i.fa-solid.fa-text-size

              - unless @message.new_record?
                = f.button t("messages.captions.delete_draft"),
                          type: "submit",
                          title: "Delete this draft",
                          value: t("messages.captions.delete_draft"),
                          name: "commit",
                          onclick: "return confirm('Are you sure you want to delete this draft?');",
                          class: "w-full md:w-fit px-3 py-2 text-lime-600 hover:text-lime-700 cursor-pointer" do

                  i.fa-solid.fa-trash

javascript:
  document.querySelectorAll(".delivery-method-checkbox").forEach(function(elem) {
    elem.addEventListener("click", function(event) {
      validateForm();
    });
  });

  function validateForm() {
    var formValid = true;

    var deliveryMethodsContainer = document.querySelector("#delivery_methods_container");
    var deliveryMethodCount = deliveryMethodsContainer.querySelectorAll("input:checked").length;
    formValid = formValid && (deliveryMethodCount > 0);

    var sendMessageButton = document.querySelector("#send_message_button");
    sendMessageButton.disabled = !formValid;
  }

css:
  trix-toolbar {
    display: none;
  }

  .formatting-active trix-toolbar {
    display: block;
  }

  trix-editor {
    min-height: 20rem;
  }

  trix-editor:empty:not(:focus)::before {
    color: #a8a29e;
  }

  .audience-item.active a {
    background-color: #E66425;
    color: white;
    font-weight: bold;
  }

  input[type='radio'].audience-checkbox:checked ~ span {
    background-color: #E66425;
    color: white;
    font-weight: bold;
  }

  #recipient_list li {
    display: inline-block;
  }

  #recipient_list li:after {
    content: ";\00a0";
  }

  #recipient_list li:last-child:after {
    content: "";
  }

  #recipient_list ul {
    margin: 0.5rem 0.5rem 3rem 0.5rem;
  }

  #recipient_count:empty {
    display: none;
  }

  trix-toolbar .trix-button-group.trix-button-group--file-tools {
    display: none;
  }

  .search-result.contactable {
    cursor: pointer;
  }

  .search-result.not-contactable {
    cursor: not-allowed;
  }

  .search-result.not-contactable .name {
    color: #a3e635;
  }

  .search-result.not-contactable .contact-methods {
    color: #a3e635;
  }  

  .search-result.selected {
    background: #365314;
  }

  #recipients li {
    display: inline-block;
  }
